name: Build CryptoApp for Mac

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-mac-app:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install CMake
      run: |
        brew install cmake
        xcode-select --install || true
    
    - name: Build Lockstitch Library
      run: |
        cd Claudo/lockstitch_files
        mkdir -p build
        cd build
        cmake -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_BUILD_TYPE=Release ..
        make -j4
        echo "=== Library Built ==="
        ls -lh liblockstitch.a
    
    - name: Create App Package
      run: |
        cd Claudo/lockstitch_files
        mkdir -p CryptoApp-ready
        
        # Copy everything needed
        cp build/liblockstitch.a CryptoApp-ready/
        cp CMakeLists.txt CryptoApp-ready/
        cp Lockstitch.h CryptoApp-ready/
        cp Lockstitch.cpp CryptoApp-ready/
        cp pch.h CryptoApp-ready/
        cp pch.cpp CryptoApp-ready/
        cp framework.h CryptoApp-ready/
        cp LockstitchBridge.h CryptoApp-ready/
        cp LockstitchBridge.mm CryptoApp-ready/
        cp CryptoApp.swift CryptoApp-ready/
        cp Info.plist CryptoApp-ready/
        cp RUN_DEMO.command CryptoApp-ready/
        chmod +x CryptoApp-ready/RUN_DEMO.command
        
        echo "=== Package Contents ==="
        ls -lh CryptoApp-ready/
    
    - name: Upload App Package
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-macOS-ready
        path: Claudo/lockstitch_files/CryptoApp-ready/
        retention-days: 30
