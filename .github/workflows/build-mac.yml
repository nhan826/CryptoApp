name: Build Lockstitch Mac Library & App

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-library:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        brew install cmake
        xcode-select --install || true
    
    - name: Create build directory
      run: mkdir -p Claudo/lockstitch_files/build
    
    - name: Run CMake
      run: |
        cd Claudo/lockstitch_files/build
        cmake -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_BUILD_TYPE=Release ..
    
    - name: Build Library
      run: |
        cd Claudo/lockstitch_files/build
        make -j4
    
    - name: Check Build Output
      run: |
        echo "=== Build Output ==="
        ls -la Claudo/lockstitch_files/build/
        file Claudo/lockstitch_files/build/liblockstitch.a || echo "Library file not found"
    
    - name: Upload Library Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lockstitch-mac-libraries
        path: Claudo/lockstitch_files/build/liblockstitch.a
        if-no-files-found: warn
        retention-days: 30

  build-app:
    runs-on: macos-latest
    needs: build-library
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Library Artifacts
      uses: actions/download-artifact@v4
      with:
        name: lockstitch-mac-libraries
        path: Claudo/lockstitch_files/build/
    
    - name: Setup Xcode Build Environment
      run: |
        xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
    
    - name: Create Xcode Project Structure
      run: |
        mkdir -p CryptoApp-macOS/CryptoApp
        mkdir -p CryptoApp-macOS/Lockstitch
        mkdir -p CryptoApp-macOS/CryptoApp.xcodeproj
    
    - name: Copy Source Files
      run: |
        # Copy lockstitch library files
        cp Claudo/lockstitch_files/Lockstitch.h CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/Lockstitch.cpp CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/pch.h CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/pch.cpp CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/framework.h CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/LockstitchWrapper.h CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/LockstitchWrapper.mm CryptoApp-macOS/Lockstitch/
        cp Claudo/lockstitch_files/CMakeLists.txt CryptoApp-macOS/Lockstitch/
        
        # Copy built library
        cp Claudo/lockstitch_files/build/liblockstitch.a CryptoApp-macOS/Lockstitch/
        
        # Copy UI files
        cp Claudo/lockstitch_files/ViewController.swift CryptoApp-macOS/CryptoApp/
        
        # Copy demo files to root
        cp Claudo/lockstitch_files/CryptoApp-Demo.swift CryptoApp-macOS/
        cp Claudo/lockstitch_files/RUN_DEMO.command CryptoApp-macOS/
        chmod +x CryptoApp-macOS/RUN_DEMO.command
        
        # Copy Code.txt if it exists
        if [ -f "Claudo/code.txt" ]; then
          cp Claudo/code.txt CryptoApp-macOS/CryptoApp/Code.txt
        fi
    
    - name: Create Project.pbxproj
      run: |
        cat > CryptoApp-macOS/CryptoApp.xcodeproj/project.pbxproj << 'EOF'
        // !$*UTF8*$!
        {
          archiveVersion = 1;
          classes = {};
          objectVersion = 54;
          objects = {
            0001 /* CryptoApp */ = {isa = PBXProject; attributes = {BuildIndependentTargetsInParallel = 1; LastSwiftUpdateCheck = 1400; LastUpgradeCheck = 1400;}; buildConfigurationList = 0002; classesForRDD = {}; compatibilityVersion = "Xcode 13.0"; developmentRegion = en; hasScannedForEncodings = 0; knownRegions = (en, Base); mainGroup = 0003; productRefGroup = 0004; projectDirPath = ""; projectRoot = ""; targets = (0005)};
            0002 /* Build configuration list */ = {isa = XCConfigurationList; buildConfigurations = (0006, 0007); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release;};
            0003 /* CryptoApp */ = {isa = PBXGroup; children = (0008, 0009); name = CryptoApp; sourceTree = "<group>";};
            0004 /* Products */ = {isa = PBXGroup; children = (0010); name = Products; sourceTree = "<group>";};
            0005 /* CryptoApp */ = {isa = PBXNativeTarget; buildConfigurationList = 0011; buildPhases = (0012, 0013, 0014); buildRules = (); dependencies = (); name = CryptoApp; productName = CryptoApp; productReference = 0010; productType = "com.apple.product-type.application";};
            0006 /* Debug */ = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; CODE_SIGN_STYLE = Automatic; COMBINE_HIDPI_IMAGES = YES; CURRENT_PROJECT_VERSION = 1; DEVELOPMENT_TEAM = ""; ENABLE_HARDENED_RUNTIME = YES; INFOPLIST_FILE = CryptoApp/Info.plist; LD_RUNPATH_SEARCH_PATHS = (runtime, "@executable_path/../Frameworks"); MACOSX_DEPLOYMENT_TARGET = 10.13; MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.cryptoapp.macos; PRODUCT_NAME = CryptoApp; SWIFT_VERSION = 5.0;};};
            0007 /* Release */ = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; CODE_SIGN_STYLE = Automatic; COMBINE_HIDPI_IMAGES = YES; CURRENT_PROJECT_VERSION = 1; DEVELOPMENT_TEAM = ""; ENABLE_HARDENED_RUNTIME = YES; INFOPLIST_FILE = CryptoApp/Info.plist; LD_RUNPATH_SEARCH_PATHS = (runtime, "@executable_path/../Frameworks"); MACOSX_DEPLOYMENT_TARGET = 10.13; MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.cryptoapp.macos; PRODUCT_NAME = CryptoApp; SWIFT_VERSION = 5.0;};};
            0008 /* ViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift.file; path = ViewController.swift; sourceTree = "<group>";};
            0009 /* Info.plist */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.plist.xml; path = Info.plist; sourceTree = "<group>";};
            0010 /* CryptoApp.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = CryptoApp.app; sourceTree = BUILT_PRODUCTS_DIR;};
            0011 /* Build configuration list */ = {isa = XCConfigurationList; buildConfigurations = (0006, 0007); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release;};
            0012 /* Sources */ = {isa = PBXSourcesBuildPhase; buildActionMask = 2147483647; files = (0015); runOnlyForDeploymentPostprocessing = 0;};
            0013 /* Frameworks */ = {isa = PBXFrameworksBuildPhase; buildActionMask = 2147483647; files = (); runOnlyForDeploymentPostprocessing = 0;};
            0014 /* Resources */ = {isa = PBXResourcesBuildPhase; buildActionMask = 2147483647; files = (); runOnlyForDeploymentPostprocessing = 0;};
            0015 /* ViewController.swift */ = {isa = PBXBuildFile; fileRef = 0008;};
          };
          rootObject = 0001;
        }
        EOF
    
    - name: Create Info.plist
      run: |
        cat > CryptoApp-macOS/CryptoApp/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleDevelopmentRegion</key>
          <string>en</string>
          <key>CFBundleExecutable</key>
          <string>CryptoApp</string>
          <key>CFBundleIdentifier</key>
          <string>com.cryptoapp.macos</string>
          <key>CFBundleInfoDictionaryVersion</key>
          <string>6.0</string>
          <key>CFBundleName</key>
          <string>CryptoApp</string>
          <key>CFBundlePackageType</key>
          <string>APPL</string>
          <key>CFBundleShortVersionString</key>
          <string>1.0</string>
          <key>CFBundleVersion</key>
          <string>1</string>
          <key>LSMinimumSystemVersion</key>
          <string>10.13</string>
          <key>NSMainStoryboardFile</key>
          <string>Main</string>
          <key>NSPrincipalClass</key>
          <string>NSApplication</string>
        </dict>
        </plist>
        EOF
    
    - name: Build Library with CMake
      run: |
        cd CryptoApp-macOS/Lockstitch
        mkdir -p build
        cd build
        cmake -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" ..
        make
    
    - name: Display Build Artifacts
      run: |
        echo "=== Library Artifacts ==="
        ls -lah CryptoApp-macOS/Lockstitch/build/ || echo "Build directory not found"
        echo ""
        echo "=== Source Files Ready ==="
        ls -la CryptoApp-macOS/Lockstitch/
        ls -la CryptoApp-macOS/CryptoApp/
    
    - name: Upload Library Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-compiled-library
        path: CryptoApp-macOS/Lockstitch/build/liblockstitch.a
        retention-days: 30
    
    - name: Upload Complete Project
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-macOS-project
        path: CryptoApp-macOS/
        retention-days: 30
    
    - name: Create Source Code Package
      run: |
        cd CryptoApp-macOS
        zip -r CryptoApp-macOS-source.zip . -x "*.git*" "build/*" "*.o" "*.a"
    
    - name: Upload Source Package
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-macOS-source
        path: CryptoApp-macOS/CryptoApp-macOS-source.zip
        retention-days: 30

  create-release:
    runs-on: macos-latest
    needs: [build-library, build-app]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          lockstitch-mac-libraries/liblockstitch.a
          lockstitch-mac-libraries/liblockstitch.dylib
        body: |
          ## Lockstitch Mac Build Release
          
          - **liblockstitch.a** - Universal binary (Intel + Apple Silicon)
          - **liblockstitch.dylib** - Shared library
          
          See MAC_BUILD_INSTRUCTIONS.md for integration details.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
