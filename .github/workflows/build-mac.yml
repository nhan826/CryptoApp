name: Build CryptoApp - Complete App Bundle

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-mac-app:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Complete App Bundle
      run: |
        cd Claudo/lockstitch_files
        mkdir -p build_final
        cd build_final
        
        # Compile C++ bridge for x86_64 (Intel Mac)
        clang++ -c ../LockstitchBridge.mm -o LockstitchBridge.o -arch x86_64 -fPIC -fmodules -std=c++17 -I..
        echo "✅ Bridge compiled for x86_64"
        
        # Compile Lockstitch library for x86_64 (Intel Mac)
        clang++ -c ../Lockstitch.cpp -o Lockstitch.o -arch x86_64 -fPIC -std=c++17 -I..
        echo "✅ Lockstitch compiled for x86_64"
        
        # Compile Swift to single executable with C++ linking for x86_64 (Intel Mac)
        swiftc ../main.swift ../CryptoApp.swift \
          LockstitchBridge.o Lockstitch.o \
          -parse-as-library \
          -lc++ \
          -o CryptoApp \
          -target x86_64-apple-macos11 \
          -framework Cocoa \
          -framework AppKit
        echo "✅ Swift compiled for x86_64"
        
        # Create app bundle structure
        mkdir -p CryptoApp.app/Contents/MacOS
        mkdir -p CryptoApp.app/Contents/Resources
        mv CryptoApp CryptoApp.app/Contents/MacOS/
        cp ../Info.plist CryptoApp.app/Contents/
        chmod +x CryptoApp.app/Contents/MacOS/CryptoApp
        
        echo "✅ App bundle created"
        ls -lh CryptoApp.app/Contents/MacOS/CryptoApp
    
    - name: Upload App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-Ready-to-Run
        path: Claudo/lockstitch_files/build_final/CryptoApp.app/
        retention-days: 30

