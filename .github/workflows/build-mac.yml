name: Build CryptoApp - Complete App Bundle

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-mac-app:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Complete App Bundle (Universal Binary)
      run: |
        cd Claudo/lockstitch_files
        mkdir -p build_final
        cd build_final
        
        # Build for x86_64 (Intel Mac)
        echo "üî® Building for x86_64 (Intel)..."
        clang++ -c ../LockstitchBridge.mm -o LockstitchBridge-x86_64.o -arch x86_64 -fPIC -fmodules -std=c++17 -stdlib=libc++ -I..
        clang++ -c ../Lockstitch.cpp -o Lockstitch-x86_64.o -arch x86_64 -fPIC -std=c++17 -stdlib=libc++ -I..
        swiftc ../main.swift ../CryptoApp.swift \
          LockstitchBridge-x86_64.o Lockstitch-x86_64.o \
          -parse-as-library \
          -Xcc -stdlib=libc++ \
          -lSystem -lc++ -lc++abi -lobjc \
          -o CryptoApp-x86_64 \
          -target x86_64-apple-macos11 \
          -framework Cocoa -framework AppKit
        echo "‚úÖ x86_64 build complete"
        
        # Build for arm64 (Apple Silicon)
        echo "üî® Building for arm64 (Apple Silicon)..."
        clang++ -c ../LockstitchBridge.mm -o LockstitchBridge-arm64.o -arch arm64 -fPIC -fmodules -std=c++17 -stdlib=libc++ -I..
        clang++ -c ../Lockstitch.cpp -o Lockstitch-arm64.o -arch arm64 -fPIC -std=c++17 -stdlib=libc++ -I..
        swiftc ../main.swift ../CryptoApp.swift \
          LockstitchBridge-arm64.o Lockstitch-arm64.o \
          -parse-as-library \
          -Xcc -stdlib=libc++ \
          -lSystem -lc++ -lc++abi -lobjc \
          -o CryptoApp-arm64 \
          -target arm64-apple-macos11 \
          -framework Cocoa -framework AppKit
        echo "‚úÖ arm64 build complete"
        
        # Create universal binary using lipo
        echo "üîó Merging into universal binary..."
        lipo -create CryptoApp-x86_64 CryptoApp-arm64 -output CryptoApp
        echo "‚úÖ Universal binary created"
        file CryptoApp
        
        # Create app bundle structure
        mkdir -p CryptoApp.app/Contents/MacOS
        mkdir -p CryptoApp.app/Contents/Resources
        mv CryptoApp CryptoApp.app/Contents/MacOS/
        cp ../Info.plist CryptoApp.app/Contents/
        chmod +x CryptoApp.app/Contents/MacOS/CryptoApp
        
        echo "‚úÖ App bundle created"
        ls -lh CryptoApp.app/Contents/MacOS/CryptoApp
        
        # Code sign the app (ad-hoc signing for distribution)
        echo "üîê Code signing app..."
        codesign --force --deep --sign - CryptoApp.app/
        echo "‚úÖ App signed successfully"
        codesign --verify --verbose CryptoApp.app/
        
        # Create a zip file of the app for distribution
        echo "üì¶ Creating distributable zip file..."
        cd ..
        zip -r CryptoApp-Ready-to-Run.zip build_final/CryptoApp.app
        echo "‚úÖ Zip file created"
    
    - name: Upload App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-Ready-to-Run
        path: Claudo/lockstitch_files/CryptoApp-Ready-to-Run.zip
        retention-days: 30

